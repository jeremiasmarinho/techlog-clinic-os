<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Test Financial Functions</title>
</head>
<body>
    <h1>Testing Financial Functions</h1>
    <div id="results"></div>

    <script>
        // Copy of financial functions from kanban.js
        function formatCurrency(value) {
            if (!value) return '';
            const number = parseCurrency(value);
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(number);
        }

        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            return parseFloat(value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        }

        function parseFinancialData(notes) {
            if (!notes) return { paymentType: '', insuranceName: '', paymentValue: '' };
            
            try {
                const match = notes.match(/\{"financial":\{[^}]+\}\}/);
                if (match) {
                    const data = JSON.parse(match[0]);
                    return {
                        paymentType: data.financial.paymentType || '',
                        insuranceName: data.financial.insuranceName || '',
                        paymentValue: data.financial.value || ''
                    };
                }
            } catch (e) {
                console.log('No financial data found in notes');
            }
            
            return { paymentType: '', insuranceName: '', paymentValue: '' };
        }

        function encodeFinancialData(notes, financialData) {
            const cleanNotes = notes.replace(/\{"financial":\{[^}]+\}\}/g, '').trim();
            
            if (financialData.paymentType || financialData.paymentValue) {
                const financialJson = JSON.stringify({
                    financial: {
                        paymentType: financialData.paymentType,
                        insuranceName: financialData.insuranceName || '',
                        value: financialData.paymentValue || ''
                    }
                });
                return `${cleanNotes}\n${financialJson}`.trim();
            }
            
            return cleanNotes;
        }

        // Run tests
        const results = [];
        
        try {
            // Test 1: Format Currency
            const formatted = formatCurrency('250.00');
            results.push(`✅ formatCurrency('250.00') = ${formatted}`);
            
            // Test 2: Parse Currency
            const parsed = parseCurrency('R$ 1.500,00');
            results.push(`✅ parseCurrency('R$ 1.500,00') = ${parsed}`);
            
            // Test 3: Parse Financial Data
            const testNotes = 'Paciente com dor\n{"financial":{"paymentType":"plano","insuranceName":"Unimed","value":"300.00"}}';
            const financialData = parseFinancialData(testNotes);
            results.push(`✅ parseFinancialData() = ${JSON.stringify(financialData)}`);
            
            // Test 4: Encode Financial Data
            const encoded = encodeFinancialData('Paciente com dor', {
                paymentType: 'particular',
                insuranceName: '',
                paymentValue: '250.00'
            });
            results.push(`✅ encodeFinancialData() = ${encoded}`);
            
            results.push('<br><strong>✅ All functions working correctly!</strong>');
            
        } catch (error) {
            results.push(`❌ Error: ${error.message}`);
            console.error(error);
        }
        
        document.getElementById('results').innerHTML = results.join('<br>');
    </script>
</body>
</html>
